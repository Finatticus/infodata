<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" /> <title>FCN Simulator — 完整可執行版（對齊 VBA）</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"> <style> :root {
  --bg: #f5f7fa;       
  --panel: #ffffff;     
  --muted: #7a7a7a;      
  --accent: #1fb6ff;      
  --card: #e0e6f0;    
  --lightText: #1a1a1a;    
  --border: rgba(0,0,0,0.08); 
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;} 
body {
  background: linear-gradient(180deg, #f5f7fa 0%, #e0e6f0 70%);
  color: var(--lightText);
}

.container{
  max-width:1350px;
  margin:0 auto;
  display:grid;
  grid-template-columns:900px 1fr;
  gap:22px;
}
.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

h1{margin:0 0 12px 0;font-size:18px;font-weight:700;color:var(--lightText)}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;}
.field{margin-bottom:12px;}
input[type="number"], select {
  background: #ffffff;
  color: var(--lightText);
  border: 1px solid rgba(0,0,0,0.1);
}

.row{display:flex;gap:10px;}
.row .field{flex:1}
.btn{
  display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:0;
  background:linear-gradient(90deg,var(--accent),#4cc9ff);color:#00151b;font-weight:700;cursor:pointer;font-size:14px;
}
.muted{color:var(--muted);font-size:13px}
.small{font-size:12px;color:var(--muted)}
.results{padding:16px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);margin-top:14px;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;} .kpi {background: var(--card);padding:12px;border-radius:8px;text-align:center}
.kpi .title{font-size:12px;color:var(--muted)}
.kpi .val{font-size:16px;font-weight:700;margin-top:6px}
canvas{background: #f9fbfd;border-radius:8px;width:100% !important;} footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:right}
.top-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.legend{display:flex;gap:8px;align-items:center}
.chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:13px;color:var(--muted)}
.note{font-size:12px;color:var(--muted);margin-top:8px}
#log{min-height:420px;white-space:pre-wrap;color:#cfe9ff;background:rgba(255,255,255,0.01);padding:12px;border-radius:8px;overflow:auto}
.section-title{font-weight:600;color:var(--lightText);margin-bottom:10px}
#scenarioChart { height: 520px !important; } .hide-ui { display: none; } @media (max-width:1400px){
  .container{padding:0 10px}
}
.section-wrapper {
    position: relative; 
}

.back-btn {
    position: absolute;
    left: 20px;  
    top: 0px;   

    background: #ffffff;
    color: #004c91;
    border: 2px solid #1f72c6;
    padding: 7px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: 0.3s;
}

.back-btn:hover {
    background: #e6f0ff;
}
</style>
</head>
<body>

<div class="section-wrapper">
<button class="back-btn" onclick="window.location.href='index.html'">←返回主頁</button>

<div class="container">
  <!-- Left input panel -->
  <div class="panel">
    <div class="top-row">
      <h1>FCN Simulator</h1>
      <div class="legend">
        <div class="chip">Simulations: 100000</div>
        <div class="chip">Seed: 12345</div>
      </div>
    </div>

    <div class="field">
      <label>Initial Price（現價）</label>
      <input id="initialPrice" type="number" step="0.0001" value="100" />
    </div>

    <div class="row">
      <div class="field">
        <label>Coupon（年票息率，%）</label>
        <input id="coupon" type="number" step="0.01" value="10" />
      </div>
      <div class="field">
        <label>天期（months，請以月為單位輸入）</label>
        <input id="tenorMonths" type="number" step="1" value="12" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>Strike（相對初始股價，輸入比例，例如0.75）</label>
        <input id="strikeRatio" type="number" step="0.0001" value="0.75" />
      </div>
      <div class="field">
        <label>KO（敲出價比率例如 1.05）</label>
        <input id="koRatio" type="number" step="0.0001" value="1.05" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>KI（敲入價比率例如 0.6）</label>
        <input id="kiRatio" type="number" step="0.0001" value="0.6" />
      </div>
      <div class="field">
        <label>保證領息期間 (m，整數月)</label>
        <input id="couponGuaranteeMonths" type="number" step="1" value="1" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>波動度（年化，%）</label>
        <input id="volatility" type="number" step="0.01" value="50" />
      </div>
      <div class="field">
        <label>無風險利率（年化，%）</label>
        <input id="rpluscds" type="number" step="0.01" value="4" />
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;align-items:center;">
      <button class="btn" id="runBtn">Run Simulation</button>
      <div class="small" id="status">等待輸入並按Run...</div>
    </div>

    <div class="note">說明：僅為理論參考數據，模擬次數固定100000，亂數種子固定 12345。</div>

    <div style="margin-top:14px" class="results" id="summaryPanel" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Results</strong>
        <div class="small" id="runtimeInfo"></div>
      </div>
      <div style="margin-top:10px" class="grid-2">
        <div class="kpi">
          <div class="title">Average Return</div>
          <div class="val" id="avgReturn">-</div>
        </div>
        <div class="kpi">
          <div class="title">Average Period (days)</div>
          <div class="val" id="avgPeriod">-</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <canvas id="scenarioChart"></canvas>
      </div>

      <div style="margin-top:12px">
        <strong>Scenario probabilities</strong>
        <div id="scenarioList" class="small" style="margin-top:6px;white-space:pre-wrap"></div>
      </div>

      <div style="margin-top:12px">
        <strong>VaR / CVaR</strong>
        <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
          <div class="chip">99% VaR: <span id="var99">-</span> / CVaR: <span id="cvar99">-</span></div>
          <div class="chip">98% VaR: <span id="var98">-</span> / CVaR: <span id="cvar98">-</span></div>
          <div class="chip">97% VaR: <span id="var97">-</span> / CVaR: <span id="cvar97">-</span></div>
          <div class="chip">95% VaR: <span id="var95">-</span> / CVaR: <span id="cvar95">-</span></div>
          <div class="chip">90% VaR: <span id="var90">-</span> / CVaR: <span id="cvar90">-</span></div>
        </div>
      </div>
      <footer>Michael Huang 02-27149852</footer>
    </div>
  </div>

  <!-- Right panel: log -->
  <div class="panel">
    <h1>Details / Log</h1>
    <div id="log"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const logEl = document.getElementById('log'); function log(msg){
    logEl.textContent = (new Date()).toLocaleTimeString() + " | " + msg + "\n" + logEl.textContent; }

function seedRandomGenerator(seed) {
    const m = 0x80000000;
    const a = 1103515245;
    const c = 12345;
    let state = seed ? seed : Math.floor(Math.random() * (m-1));
    return function() {
        state = (a * state + c) % m;
        return state / (m - 1);
    };
}

function boxMuller(u1, u2) {
    const r = Math.sqrt(-2.0 * Math.log(u1));
    const theta = 2.0 * Math.PI * u2;
    return [r * Math.cos(theta), r * Math.sin(theta)]; }

let scenarioChart = null;

document.getElementById('runBtn').addEventListener('click', ()=> {
    try {
        runFixedSimulation();
    } catch(err) {
        log("Error: " + (err && err.message ? err.message : String(err)));
        document.getElementById('status').textContent = "Error during simulation (see log)";
    }
});

function runFixedSimulation(){
    // 讀取輸入
    const initialPrice = parseFloat(document.getElementById('initialPrice').value) || 100;
    const couponPct = parseFloat(document.getElementById('coupon').value)/100;
    const tenorMonths = Math.max(1, Math.floor(parseFloat(document.getElementById('tenorMonths').value) || 12));
    const strikeRatio = parseFloat(document.getElementById('strikeRatio').value) || 0.75;
    const koRatio = parseFloat(document.getElementById('koRatio').value) || 1.05;
    const kiRatio = parseFloat(document.getElementById('kiRatio').value) || 0.6;
    const couponGuaranteeMonths = Math.max(0, Math.floor(parseFloat(document.getElementById('couponGuaranteeMonths').value) || 0));
    const volPct = parseFloat(document.getElementById('volatility').value)/100;
    const rpluscdsPct = parseFloat(document.getElementById('rpluscds').value)/100;

    document.getElementById('status').textContent = "Running...";
    document.getElementById('summaryPanel').hidden = true;
    logEl.textContent = "";

    if(couponGuaranteeMonths > tenorMonths){
        log(`錯誤：保證領息期間 (${couponGuaranteeMonths}m) 大於 天期 (${tenorMonths}m)。請修正輸入。`);
        document.getElementById('status').textContent = "Invalid inputs (see log)";
        return;
    }

    const numsimulations = 100000;
    const principal = 100.0;
    const tradingDaysYear = 252;
    const totalDays = 21*tenorMonths; // 約每月21個交易日

    // 計算每月觀察日
    const observationDays = [];
    for(let m=1; m<=tenorMonths; m++) observationDays.push(m*21);

    const strikePrice = initialPrice * strikeRatio;
    const knockoutPrice = initialPrice * koRatio;
    const knockinPrice = initialPrice * kiRatio;

    const payoff = new Array(numsimulations).fill(0);
    const period = new Array(numsimulations).fill(0);
    const scenarioFlags = new Array(numsimulations);
    let kiTouches = 0;

    const rng = seedRandomGenerator(1234);
    const t0 = performance.now();

    for(let sim=0; sim<numsimulations; sim++){
        let stock = initialPrice;
        let knockedIn = false;
        let payoffSim = 0;
        let minRatio = Infinity;
        let scenarioIndex = -1;

        for(let day=1; day<=totalDays; day++){
            let u1 = rng(), u2 = rng();
            if(u1 <= 1e-12) u1 = 1e-12;
            const [z0, z1] = boxMuller(u1, u2);
            const z = z0;

            const drift = (rpluscdsPct - 0.5*volPct*volPct)/tradingDaysYear;
            const diffusion = Math.sqrt(1.0/tradingDaysYear)*volPct*z;
            stock = stock * Math.exp(drift + diffusion);

            const ratio = stock / strikePrice;
            if(ratio < minRatio) minRatio = ratio;
            if(stock < knockinPrice) knockedIn = true;

            // KO check
            if(observationDays.includes(day) && stock > knockoutPrice){
                const couponAccrual = Math.max(0, (day-5)/tradingDaysYear);
                payoffSim = principal*(1 + couponAccrual*couponPct)*Math.exp(-rpluscdsPct*(day/tradingDaysYear));
                period[sim] = day;
                scenarioIndex = observationDays.indexOf(day); // 0 ~ tenorMonths-1
                break; // first KO only
            }
        }

        // 到期處理
        if(scenarioIndex === -1){
            period[sim] = totalDays;
            const couponAccrual = Math.max(0, (totalDays-5)/tradingDaysYear);
            if(stock >= strikePrice || !knockedIn){
                payoffSim = principal*(1 + couponAccrual*couponPct)*Math.exp(-rpluscdsPct*(totalDays/tradingDaysYear));
                scenarioIndex = tenorMonths; // Scenario 13
            } else {
                payoffSim = principal*minRatio + principal*couponAccrual*couponPct * Math.exp(-rpluscdsPct*(totalDays/tradingDaysYear));
                scenarioIndex = tenorMonths+1; // Scenario 14
            }
        }

        scenarioFlags[sim] = new Array(tenorMonths+2).fill(0);
        scenarioFlags[sim][scenarioIndex] = 1;
        if(knockedIn) kiTouches++;
        payoff[sim] = payoffSim;
    }

    const t1 = performance.now();

    // 統計
    function mean(arr){ let s=0; for(let v of arr)s+=v; return s/arr.length; }
    function std(arr){ const m=mean(arr); let s=0; for(let v of arr) s+=(v-m)*(v-m); return Math.sqrt(s/(arr.length-1)); }

    const avgReturn = mean(payoff);
    const avgPeriod = mean(period);

    // scenario probabilities
    const totalscenario = new Array(tenorMonths+2).fill(0);
    for(let sim=0; sim<numsimulations; sim++){
        totalscenario[scenarioFlags[sim].indexOf(1)] += 1;
    }
    for(let j=0;j<totalscenario.length;j++) totalscenario[j] /= numsimulations;

    // update UI
    document.getElementById('avgReturn').textContent = avgReturn.toFixed(8);
    document.getElementById('avgPeriod').textContent = avgPeriod.toFixed(2);
    document.getElementById('runtimeInfo').textContent = `took ${(t1-t0).toFixed(0)} ms`;

    const scenarioNames = [];
    for(let i=1;i<=totalscenario.length;i++) scenarioNames.push(i.toString());

    let scenText = '';
    for(let i=0;i<totalscenario.length;i++){
        scenText += `${i+1}. ${scenarioNames[i]} : ${(totalscenario[i]*100).toFixed(4)}% \n`;
    }
    document.getElementById('scenarioList').textContent = scenText;

    const scenarioDataPct = totalscenario.map(x => +(x*100).toFixed(6));
    const ctx = document.getElementById('scenarioChart').getContext('2d');
    if(scenarioChart) scenarioChart.destroy();
    scenarioChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: scenarioNames,
            datasets: [{
                label:'Probability (%)',
                data: scenarioDataPct,
                backgroundColor: 'rgba(31,182,255,0.9)',
                borderColor: 'rgba(31,182,255,0.95)',
                borderWidth: 1
            }]
        },
        options: {
            plugins:{legend:{display:false}},
            scales:{
                x:{ticks:{color:'#cfe9ff'},grid:{display:false}, title:{display:false}},
                y:{ticks:{color:'#cfe9ff'},grid:{color:'rgba(255,255,255,0.03)'}, beginAtZero:true, title:{display:true, text:'Probability (%)', color:'#cfe9ff'}}
            },
            responsive:true,
            maintainAspectRatio:false
        }
    });

    document.getElementById('summaryPanel').hidden = false;
    document.getElementById('status').textContent = 'Simulation complete';
    log(`Simulation complete. avgReturn=${avgReturn.toFixed(8)}, avgPeriod=${avgPeriod.toFixed(2)}, time=${(t1-t0).toFixed(0)}ms`); } </script>

 </body> </html>
